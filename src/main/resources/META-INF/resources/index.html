<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>airrow</title>
    <style>
      html, 
      body {
          height: 100%;
          margin: 0;
      }
      
      #screen {
        display: flex;
        flex-direction: column;
        height: 100%
      }
      
      #status-container {
        transition: background-color 1s ease;
        height: 1em;
      }
      
      #debug-container {
        height: 1em;
      }
      
      #nav-element {
        transition: transform 2000ms ease;
        transform-origin: center center;
        display: inline-block; /* shrink wrap */
        font-size: 50vh;
      }
      
      .nav-container {
        display:flex;
        justify-content:center;
        align-items:center;
        flex-grow: 1;
      }
    </style>
    <script type="text/javascript">
    var orientationFix = 0;
    var absoluteAngle = 0;

    document.addEventListener('DOMContentLoaded', function(event) {

      var options = {
        enableHighAccuracy: true,
        timeout: 1000,
        maximumAge: 2000
      };
      var sessionId = document.cookie.replace(/(?:(?:^|.*;\s*)sessionId\s*\=\s*([^;]*).*$)|^.*$/, "$1");
      
      
      if (sessionId === "") {
        sessionId = generateUUID();
        document.cookie = "sessionId=" + sessionId + ";max-age=86400";
      }
      console.log(sessionId);
      
      function heartbeat() {
        navigator.geolocation.getCurrentPosition(update_coordinates, geo_fail, options);
      }
      
      function update_coordinates(position) {
          latitude  = position.coords.latitude;
          longitude = position.coords.longitude;
          
          console.log("lat: " + latitude + " long: " + longitude);
          console.log(sessionId);
          
          var xmlhttp = new XMLHttpRequest();
          var theUrl = "/point/" + sessionId;
          xmlhttp.onload = updateNavigation;
          xmlhttp.open("POST", theUrl);
          xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
          xmlhttp.send(JSON.stringify({"direction": 0, "latitude": latitude, "longitude": longitude}));
          var div = document.getElementById('status-container');
          
          div.style.backgroundColor = "#89bba0";
          
          if (this.response === "") {
            console.log("No direction");
            return;
          }
          var direction = JSON.parse(this.response);
          absoluteAngle = direction.angle;
          console.log("Updating navigation: " + absoluteAngle);
          updateNavigation();
      }
      
      function geo_fail(err) {
        console.warn("error:" + err.message);
        var div = document.getElementById('status-container');
        
        div.style.backgroundColor = "#b38787";
      }
      
      function handleOrientation(event) {
        var absolute = event.absolute;
        var alpha    = event.alpha;
        var beta     = event.beta;
        var gamma    = event.gamma;

        var div = document.getElementById('debug-container');
        div.innerHTML  = "northed : " + absolute + "\n";
        orientationFix = alpha;
        updateNavigation();
      }
      
      window.setInterval(heartbeat, 2000);
      window.addEventListener("deviceorientation", handleOrientation, true);
    })
    
    function updateNavigation() {
      var div = document.getElementById('nav-element');
      var relativeAngle = absoluteAngle + orientationFix;
      
      var debug = document.getElementById('debug-container');
      debug.innerHTML  += "absoluteAngle : " + absoluteAngle + "\n";
      debug.innerHTML  += "orientationFix : " + orientationFix + "\n";
      
      div.style.transform = 'rotate('+ relativeAngle +'deg)';
    }
    
    function generateUUID() { // Public Domain/MIT
        var d = new Date().getTime();//Timestamp
        var d2 = (performance && performance.now && (performance.now()*1000)) || 0;//Time in microseconds since page-load or 0 if unsupported
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16;//random number between 0 and 16
            if(d > 0){//Use timestamp until depleted
                r = (d + r)%16 | 0;
                d = Math.floor(d/16);
            } else {//Use microseconds since page-load if supported
                r = (d2 + r)%16 | 0;
                d2 = Math.floor(d2/16);
            }
            return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
    }
    </script>
  </head>

  <body>
    <div id="screen">
      <div class="nav-container">
        <div id="nav-element">^</div>
      </div>
      <div id="debug-container">
      </div>
      <div id="status-container">
      </div>
    </div>
  </body>

</html>